# 玉盏春夜宴 (Jade Night) - 游戏原型

这是一个用于验证桌游《玉盏春夜宴》数值平衡与核心机制的数字化原型项目。基于 React + boardgame.io 开发，支持 P2P 联机对战。

## 📖 关于游戏

**《行香子·春夜宴》**

> 翠幕烟浮，红烛影流。满后园、莺语难收。香糕细点，翠袖轻勾。正宴芳华，分春色，在心头。
> 
> 老亲垂眸，玉盏清幽。递温润、且试温柔。钗环并凑，争看此瓯。愿光如旧，人如旧，岁如流。

游戏模拟了顾府春夜宴的场景，玩家扮演参与宴席的女子，通过挑选精美的“食器”与“点心”，追求色、形、味的极致搭配，博得老太君的欢心与赏赐。

## 🚀 快速开始 (开发与内测)

### 环境要求
- Node.js 18+
- pnpm

### 启动步骤

1. **安装依赖**
   ```bash
   pnpm install
   ```

2. **启动本地信令服务器** (用于 P2P 握手)
   ```bash
   pnpm server
   ```
   *注意：服务运行在端口 9000，请勿关闭此终端窗口*

3. **启动客户端**
   ```bash
   pnpm dev
   ```
   *服务默认运行在端口 5173*

4. **开始联机**
   - 打开两个浏览器窗口（推荐使用隐身模式），分别访问 `http://localhost:5173`。
   - 客户端会自动连接本地信令服务器。
   - 一个窗口创建游戏 (Host)，复制 Room ID 或等待自动连接。
   - 另一个窗口加入游戏 (Join)。

## 🎮 玩法指南 (内测版)

### 核心目标
唯一的得分来源是**配对分**。游戏结束时总分最高的玩家获胜。

### 配对机制 (Matching)
每一组「食器 + 点心」在三个维度上进行比对：
- **颜色**: 桃红 / 柳绿 / 鹅黄
- **形状**: 圆满 / 方正 / 花韵
- **温度**: 暖 / 冷
*每匹配一个维度，得 1 分。满分 3 分。*

### 食器的等级
- **Level 1 (普通)**: 单属性限制，极难匹配。适合用来“奉献”。
- **Level 2 (精品)**: 双属性兼容，容错率高。
- **Level 3 (珍宝)**: 单维度全通（万能），强力得分工具。
- **玉盏 (Legendary)**: 全维度万能，必定 3 分。

### 玩家行动 (每回合 2 AP)
| 动作                | 消耗 | 说明                                                                                                                                   |
| :------------------ | :--- | :------------------------------------------------------------------------------------------------------------------------------------- |
| **拿取 (Take)**     | 1 AP | 从公共区拿取一张食器或点心（点心必须放在空盘上）。                                                                                     |
| **品鉴 (Taste)**    | 1 AP | 将等待区的一组移入个人区。锁定得分，不再变动。<br> *奖励：每拥有2盘已结算点心，AP上限+1。*                                             |
| **奉献 (Dedicate)** | 1 AP | 将一组移入奉献区（需温度匹配）。<br> **奖励**：获得高一级的盘子（L1->L2->L3）。<br> **触发**：若满足阈值，进行老太君判定，赢取“玉盏”。 |
| **分享 (Share)**    | -    | 将同类点心所在的盘子送给对手（需对手同意/接受）。                                                                                      |

### 老太君判定规则
当场上奉献总数达到 $N_{jade}$ 时，每次奉献都会掷骰判定：
- **公式**: 判定值 $T = (N_{current} - (N_{jade} - 1)) + P_{off} (个人奉献数) + S_{pair} (当前配对分)$
- **结果**: 若 $2d6 < T$，判定成功，获得玉盏。

- **阈值设定**:
    - 2人局: $N_{jade}=10, N_{end}=12$
    - 3人局: $N_{jade}=8,  N_{end}=10$
    - 4人+: $N_{jade}=6,  N_{end}=8$

## 🛠️ 项目结构

```text
jade-night/
├── server/             # 本地 PeerJS 信令服务器 (端口 9000)
├── src/
│   ├── components/     # UI 组件 (Board, Lobby, Card)
│   ├── game/           # 游戏核心逻辑 (G, moves)
│   ├── network/        # P2P 网络通信封装
│   ├── App.tsx         # 根组件
│   └── main.tsx        # 入口
├── GamePlay.md         # 详细策划文档
└── package.json        # 项目依赖配置
```

## 📝 开发注意事项

1. **State Design**: 游戏状态存储在 boardgame.io 的 `G` 对象中。
2. **Moves**: 所有的状态变更必须通过 `moves` 定义的函数执行。
3. **P2P Debug**: 如果联机失败，请检查 `pnpm server` 是否正常运行，以及浏览器控制台是否有连接错误。开发环境默认强制连接 `localhost:9000`。
