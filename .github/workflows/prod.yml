name: prod-ci

on:
  push:
    branches:
      - prod

jobs:
  deploy_jade_night:
    runs-on: ubuntu-latest
    environment: AliServer
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4 # 升级至 v4 提升稳定性

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.7.0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Record deploy start time
        id: deploy_start
        run: echo "deploy_start=$(date -u +%s)" >> $GITHUB_ENV

      - name: Build static page
        id: build_step
        env:
          VITE_BASE_HOST: ${{ secrets.MY_HOST }}
        run: |
          pnpm install --frozen-lockfile
          pnpm run build

      - name: Deploy to Server
        id: deploy_step
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.MY_HOST }}
          username: ${{ secrets.MY_USER }}
          password: ${{ secrets.MY_PASS }}
          source: "./dist/*"
          target: /var/www/jade-night
          rm: true
          strip_components: 1

      - name: Record commit info
        id: commit_info
        run: |
          echo "commit_hash=$(echo "${GITHUB_SHA}" | cut -c1-7)" >> $GITHUB_ENV
          echo "commit_message=$(git log -1 --pretty=%B | head -n 1)" >> $GITHUB_ENV

      - name: Record deploy end time
        id: deploy_end
        run: echo "deploy_end=$(date -u +%s)" >> $GITHUB_ENV

      - name: Calculate duration
        id: duration
        run: |
          DURATION=$(( ${DEPLOY_END} - ${DEPLOY_START} ))
          echo "duration=$DURATION" >> $GITHUB_ENV
        env:
          DEPLOY_START: ${{ env.deploy_start }}
          DEPLOY_END: ${{ env.deploy_end }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Notify Feishu
        if: always()
        run: |
          # 转换UTC时间到北京时间
          START_BEIJING=$(TZ=Asia/Shanghai date -d "@${{ env.deploy_start }}" +"%Y-%m-%d %H:%M:%S")
          END_BEIJING=$(TZ=Asia/Shanghai date -d "@${{ env.deploy_end }}" +"%Y-%m-%d %H:%M:%S")

          # 格式化耗时
          DURATION=${{ env.duration }}
          HOURS=$(( DURATION / 3600 ))
          MINUTES=$(( (DURATION % 3600) / 60 ))
          SECONDS=$(( DURATION % 60 ))
          DURATION_HMS=$(printf '%02d:%02d:%02d' $HOURS $MINUTES $SECONDS)

          # 状态判断
          BUILD_STATUS=$(if [ "${{ steps.build_step.outcome }}" == 'success' ]; then echo "✅ 构建成功"; else echo "❌ 构建失败"; fi)
          DEPLOY_STATUS=$(if [ "${{ steps.deploy_step.outcome }}" == 'success' ]; then echo "✅ 部署成功"; else echo "❌ 部署失败"; fi)

          # 构建 Feishu Payload
          PAYLOAD=$(jq -n \
            --arg build_status "$BUILD_STATUS" \
            --arg deploy_status "$DEPLOY_STATUS" \
            --arg start_time "$START_BEIJING" \
            --arg end_time "$END_BEIJING" \
            --arg duration "$DURATION_HMS (${DURATION}s)" \
            --arg branch "${GITHUB_REF#refs/heads/}" \
            --arg commit_hash "${{ env.commit_hash }}" \
            --arg commit_message "${{ env.commit_message }}" \
            --arg server "${{ secrets.MY_HOST }}" \
            '
            {
              "msg_type": "interactive",
              "card": {
                "header": {
                  "title": { "tag": "plain_text", "content": "[Github Action] 部署通知" },
                  "template": (if $deploy_status | contains("✅") then "green" else "red" end)
                },
                "elements": [
                  { "tag": "div", "text": { "tag": "lark_md", "content": "**项目名**: jade-night" } },
                  { "tag": "div", "text": { "tag": "lark_md", "content": "**构建状态**: \($build_status)" } },
                  { "tag": "div", "text": { "tag": "lark_md", "content": "**部署状态**: \($deploy_status)" } },
                  { "tag": "div", "text": { "tag": "lark_md", "content": "**分支**: \($branch)" } },
                  { "tag": "div", "text": { "tag": "lark_md", "content": "**服务器**: \($server)" } },
                  { "tag": "div", "text": { "tag": "lark_md", "content": "**Commit**: \($commit_hash) (\($commit_message))" } },
                  { "tag": "hr" },
                  { "tag": "div", "text": { "tag": "lark_md", "content": "**开始时间**: \($start_time)\n**结束时间**: \($end_time)\n**总共耗时**: \($duration)" } }
                ]
              }
            }
            ')

          curl -X POST "${{ secrets.FEISHU_WEBHOOK_URL }}" \
               -H "Content-Type: application/json" \
               -d "${PAYLOAD}"
